# Server-side resource loading

## Protocol

The VoxelCsgApplied protocol message was hijacked to allow sending resources
(.nqdef, .node, meshes, soundbanks...) to the client.

The VoxelEdit payload must have constructId set to 0. Its behavior changes
based on the "flags" field:

1: load .nqdef from "operation" field (JSON data)

2: load any file into Unigine cache. File content is in "operation" field,
and relative file path in "hashContext"

3: Send an element load request with element name in "hashContext". This must
be sent for new elements, after sending all .nqdefs, nodes, meshes, ...

4: load a sound bank with file content in "operation". Note: wwise is picky
about what it accepts. Our init sound bank has project ID 0xCF0E in memory (3791),
and is version 135, generated by Wwise version 2019.2.x.

5: load a CSV file into the localization system

To ensure your new resources are available before constructs are being loaded,
it is recomended to inject them synchronously as soon as possible, for instance
in a DLL Mod's GetModInfoFor() method.

## Sample Mod

The Mod in this directory will send every file at the root of 'Mods/client' directory to each
connecting client, based on the file extension:

- .nqdef : sent to client asset manager
- .bnk : sent as sound bank
- .csv : sent as localization data
- .elr : plain text file with one element name per line, sent as element reload requests at the end
- everything else : sent to unigine filesystem RAM disk

If the file 'voxels.load' is present, voxel materials and textures will be reloaded
by the client. Use it if you inject new voxels.

Note that cached resource will be
sent with a "resources_generated/" filesystem prefix, which is required for
further resources loading by the client. Be sure to adjust your .nqdef and .node
accordingly.

## Warning

Always use lowercase file names or resource files may fail to load.


## Sample voxel nqdef

This sample expect files "<name>_c.dds", "<name>_n.dds" and "<name>_mrao.dds"
to be injected also.


```json
{
  "worlds": {
    "voxel": {
      "materialDefinitions": {
        "hcombs_v1": {
          "materialType": "non_blending",
          "layers": [
            "c",
            "n",
            "mrao"
          ],
          "materials": {
            "MyCoolVoxelHC": {
              "texture": "resources_generated/<name>",
              "albedo": [
                0.5,
                0.5,
                0.5
              ]
            }
          }
        }
      }
    }
  }
}
```
